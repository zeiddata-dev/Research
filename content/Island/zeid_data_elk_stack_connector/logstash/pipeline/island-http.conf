input {
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Optional shared-secret check. If ISLAND_SHARED_SECRET is blank, we skip it.
  if "${ISLAND_SHARED_SECRET}" != "" {
    if !([headers] and [headers][authorization] and [headers][authorization] == "Bearer ${ISLAND_SHARED_SECRET}") {
      drop { }
    }
  }

  mutate {
    add_field => {
      "[event][module]" => "island"
      "[event][dataset]" => "island.audit"
      "[observer][vendor]" => "Island"
      "[observer][product]" => "Enterprise Browser"
    }
  }

  # Preserve original payload under island.* so you can normalize later without losing truth.
  ruby {
    code => '
      event.set("[island]", event.to_hash.clone) unless event.get("[island]")
    '
  }

  # Timestamp mapping (best-effort). If your Island events have a different timestamp field,
  # change this to match it.
  if [timestamp] {
    date { match => ["timestamp", "ISO8601"] target => "@timestamp" }
  } else if [Vendor][message][timestamp] {
    date { match => ["[Vendor][message][timestamp]", "ISO8601"] target => "@timestamp" }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "island-audits-%{+YYYY.MM.dd}"
  }
  # Helpful for debugging (comment out in prod)
  stdout { codec => rubydebug }
}
